var fs = require('fs'),
	Backbone = require('backbone');

var Collection = Backbone.Collection,
	jsd = exports,
	Collections = {};
function parse(sJSON) {
	var o = JSON.parse(sJSON),
		coll = new Backbone.Collection;
	coll.add(o);
	sColl = coll.toJSON();
	coll.id = Math.round(Math.random() * 10000000000);
	sColl.find = function (opt) {
			var res = {};
			res.self = new Backbone.Collection(Collections[id].toJSON());
			res.coll = new Backbone.Collection;
			for (var key in opt) {
				res.self.each(function (model) {
					if (model.get(key) === opt[key]) {
						res.coll.add(model);
					}
				});
				res.self.reset();
				res.self.add(res.coll.toJSON());
				res.coll.reset();
			}
			return res.self.toJSON();
		};
	sColl.insert = coll.add;
	sColl.findOne = function (opt) {
		return this.find(opt)[0];
	};
	sColl.getCound = function () {
		return this.toJSON().length;
	};
	Collections[coll.id]coll;
	return coll.toJSON();
}
jsd.collection = function (collName) {
	fs.readFile('./' + collName + '.json', function (err, data) {
		if (err) {
			fs.readFile('./' + collName, function (err, data) {
				return parse(data.toString());
			});
		}
		return parse(data.toString());
	});
};
jsd.create = function (collName) {
	fs.readFile('./' + collName + '.json', function (err, data) {
		if (err) {
			fs.writeFile(collName + '.json', '');
			return this;
		}
		fs.readFile('./' + collName, function (err, data) {
			if (err) {
				fs.writeFile(collName, '');
				return this;
			}
			console.log('This collection`s file name was existed');
			return this;
		});
	});
};
